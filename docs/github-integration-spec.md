# GitHub Integration Spec v0.1

## Status: DRAFT
## Owner: Architect
## Priority: Active

---

## Problem

Hivemind agents can commit and push code, but the GitHub workflow layer is entirely manual:
- PRs must be created in the browser or by agents running `gh pr create`
- Issue linking is ad-hoc (agents mention issue numbers in commit messages)
- CI status (GitHub Actions) is invisible inside Hivemind
- Code review requests require manual browser navigation

This creates a gap between "code pushed" and "PR merged" that wastes time and breaks flow.

## Goal

Bring GitHub PR, issue, and CI workflows inside Hivemind so agents can:
1. Create/update PRs programmatically with rich context from Transition Ledger
2. Track and link GitHub issues to work items
3. Monitor CI/CD pipeline status without leaving the app
4. Trigger code review workflows from within Hivemind

## Prerequisites

- `gh` CLI installed and authenticated (already available on this machine)
- `GITHUB_TOKEN` in `.env` for API calls (or `gh auth` token)
- Existing git-handlers.js IPC channels (status, diff, log, stage, commit, branch)

## Architecture

### Layer 1: GitHub Service (`ui/modules/main/github-service.js`)

Core service that wraps the GitHub API via `gh` CLI. All GitHub operations route through here.

**Why `gh` CLI over Octokit/REST?**
- Already installed and authenticated on dev machine
- No npm dependency needed
- Handles auth token management automatically
- Consistent with how agents already use `gh` in their CLIs

**Methods:**
```
createPR({ title, body, base, head, draft }) â†’ { number, url, html_url }
updatePR(number, { title, body, state }) â†’ { number, url }
getPR(number) â†’ { number, title, body, state, mergeable, checks }
listPRs({ state, head, base }) â†’ [{ number, title, state, ... }]
mergePR(number, { method }) â†’ { merged, message }

createIssue({ title, body, labels, assignees }) â†’ { number, url }
getIssue(number) â†’ { number, title, body, state, labels }
listIssues({ state, labels }) â†’ [{ number, title, state, ... }]
closeIssue(number) â†’ { number, state }
addIssueComment(number, body) â†’ { id }

getChecks({ ref }) â†’ [{ name, status, conclusion, url }]
getWorkflowRuns({ branch, status }) â†’ [{ id, name, status, conclusion }]

getRepo() â†’ { owner, repo, default_branch, url }
```

### Layer 2: IPC Handlers (`ui/modules/ipc/github-handlers.js`)

IPC channels exposing GitHub service to renderer and WebSocket clients.

**Channels:**
```
github:create-pr       â†’ createPR(payload)
github:update-pr       â†’ updatePR(number, payload)
github:get-pr          â†’ getPR(number)
github:list-prs        â†’ listPRs(filters)
github:merge-pr        â†’ mergePR(number, options)

github:create-issue    â†’ createIssue(payload)
github:get-issue       â†’ getIssue(number)
github:list-issues     â†’ listIssues(filters)
github:close-issue     â†’ closeIssue(number)
github:comment-issue   â†’ addIssueComment(number, body)

github:get-checks      â†’ getChecks(ref)
github:get-runs        â†’ getWorkflowRuns(filters)

github:get-repo        â†’ getRepo()
github:auth-status     â†’ check if gh CLI is authenticated
```

### Layer 3: CLI Script (`ui/scripts/hm-github.js`)

WebSocket-based CLI for agents to interact with GitHub from any pane.

**Subcommands:**
```
hm-github pr create --title "..." --body "..." [--draft] [--base main]
hm-github pr list [--state open|closed|all]
hm-github pr get <number>
hm-github pr merge <number> [--method squash|merge|rebase]

hm-github issue create --title "..." --body "..." [--labels bug,feat]
hm-github issue list [--state open] [--labels ...]
hm-github issue get <number>
hm-github issue close <number>
hm-github issue comment <number> --body "..."

hm-github checks [--ref HEAD]
hm-github runs [--branch main] [--status completed]

hm-github status   (repo info + auth check)
```

### Layer 4: WebSocket Routing (`ui/modules/main/hivemind-app.js`)

Add `type: 'github'` to WebSocket message routing, forwarding to github-handlers.

### Layer 5: Transition Ledger Integration

When creating a PR, auto-populate the body with:
- Session number and commit summary
- Transition Ledger stats (transitions created, verified, failed)
- Test suite results from the session
- Link back to relevant issues

Template:
```markdown
## Summary
{agent-generated description}

## Session {N} Changes
- {commit_count} commits
- {test_suites} suites, {test_count} tests passing

## Transition Ledger
- {active} active transitions
- {verified} verified this session
- {failed} failed/timed out

## Linked Issues
- Closes #{issue_number}: {issue_title}

---
ðŸ¤– Generated by Hivemind Architect
```

## Implementation Phases

### Phase 1: Foundation (github-service.js + auth check)
- GitHub service with `gh` CLI wrapper
- Auth status check
- Repo info retrieval
- Error handling for missing `gh` / unauthenticated

### Phase 2: PR Operations (create, list, get, update, merge)
- Full PR CRUD
- Auto-body generation from git log
- Draft PR support

### Phase 3: Issue Operations (create, list, get, close, comment)
- Full issue CRUD
- Label management

### Phase 4: CI/CD Visibility (checks, workflow runs)
- Check status for any ref
- Workflow run listing and filtering

### Phase 5: IPC + CLI + WebSocket Wiring
- IPC handlers registered in handler-registry
- hm-github.js CLI script
- WebSocket routing in hivemind-app.js

### Phase 6: Transition Ledger Integration
- Auto-PR body generation with session context
- Issue linking from commit messages
- CI status polling after push

## Testing Strategy

Each phase gets its own test file:
- `github-service.test.js` â€” mock `exec` for `gh` CLI calls
- `github-handlers.test.js` â€” IPC harness tests
- `hm-github.test.js` â€” CLI argument parsing + WebSocket mock

## Security Considerations

- `GITHUB_TOKEN` never exposed to renderer process
- All GitHub operations go through main process IPC
- PR body sanitized (no raw user input injection into shell)
- `gh` CLI handles token storage securely

## Out of Scope (v0.1)

- GitHub webhook receiver (would need public URL / ngrok)
- GitHub App installation flow
- Multi-repo support
- GitHub Projects / Milestones
- Automated PR review comments from Reviewer teammate (future v0.2)
